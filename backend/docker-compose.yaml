services:

  postgres_dev:

    restart: always    
    image: postgres

    environment:
      - POSTGRES_USER=hackaton
      - POSTGRES_PASSWORD=123
      - POSTGRES_DB=hackaton
      
    volumes:
      - ./init.postgres.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgres-data:/var/lib/postgresql/data
  v3:

    depends_on:
      - redis

    build:
      context: .
      dockerfile: Dockerfile.v3 

    command: python /app/service.py 

    environment: 
      - INSTALLATION=$INSTALLATION
      - SERVER_ENVIRONMENT=$SERVERSUBDOMAIN
      - MONOLITH_APP_PORT=80
      - API_PREFIX=/api/v3
      - REDIS_HOST=redis

    volumes:
      - './src:/app'      
      - './docs:/app/docs'
      - './storage:/tmp/storage'
      - '/var/log/$INSTALLATION:/tmp/$INSTALLATION/logs'

     
     
    extra_hosts:
      - "host.docker.internal:host-gateway"


  nginx:
    image: nginx

    volumes:
      - ./nginx/nginx.$INSTALLATION.conf:/etc/nginx/conf.d/default.conf

    ports:
      - 8080:80

    depends_on:
      - v3

    environment:
      - NGINX_PORT=80
      
      
  redis:
    image: redis:alpine
    hostname: redis
    command: redis-server
    labels:
      NAME: redis

